<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Captain Pillar</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', cursive, sans-serif;
            overflow: hidden; /* No scroll on body */
            background-color: #87CEEB;
            height: 100vh;
            width: 100vw;
            touch-action: none; /* Prevent browser zooming/scrolling on touch */
        }

        #app {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            box-sizing: border-box;
            position: relative;
        }

        /* --- HEADER SECTION --- */
        .header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            z-index: 10;
        }

        .question-bar {
            padding: 0.5rem 1rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            background: #FFD700;
            width: 100%;
            max-width: 800px;
        }

        .question-text {
            font-size: clamp(1rem, 3.5vw, 1.6rem); /* Responsive text size */
            font-weight: bold;
            margin: 0;
            color: #333;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4);
            line-height: 1.2;
        }

        .controls-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-small {
            background: white;
            border: 2px solid #ddd;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            outline: none;
            user-select: none;
        }

        .btn-small:hover { transform: translateY(-2px); }
        .btn-small:active { transform: translateY(0); }

        .btn-restart { color: #d32f2f; border-color: #ffcdd2; background: #ffebee; }
        .btn-fullscreen { color: #1976d2; border-color: #bbdefb; background: #e3f2fd; }
        
        select.btn-small {
            appearance: none;
            -webkit-appearance: none;
            padding-right: 1.8rem;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem top 50%;
            background-size: 0.6rem auto;
            color: #333;
        }

        /* --- MAIN GAME LAYOUT --- */
        .game-container {
            flex: 1;
            display: flex;
            overflow: hidden; 
            gap: 1rem;
            justify-content: center;
            align-items: flex-start;
            height: 100%;
        }

        /* LEFT SIDEBAR (Legend) */
        .sidebar {
            width: 220px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 95%; 
            border: 2px solid #fff;
            flex-shrink: 0;
        }

        .sidebar-header {
            background: #f0f4f8;
            padding: 0.6rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 0.9rem;
            color: #444;
        }

        .sidebar-content {
            overflow-y: auto;
            padding: 0.5rem;
            flex: 1;
        }

        .mini-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .mini-legend-item:last-child { border-bottom: none; }
        .mini-legend-icon { font-size: 1.2rem; min-width: 25px; text-align: center; }

        /* CENTER GAME AREA */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .game-board {
            background: #FFFFFF;
            border: 4px solid #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            position: relative;
            touch-action: none; /* Critical for swipe */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-board.flash-correct { animation: flashBlue 0.5s ease; }
        .game-board.flash-wrong { animation: flashRed 0.5s ease; }

        @keyframes flashBlue { 0%, 100% { border-color: #fff; } 50% { border-color: #2196F3; } }
        @keyframes flashRed { 0%, 100% { border-color: #fff; } 50% { border-color: #F44336; } }

        .grid-container { 
            display: grid; 
            /* rows/cols set by JS */
        }

        .grid-cell {
            background-color: #F8F9FA;
            border: 1px solid #EEEEEE;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-sizing: border-box; /* Ensure border is inside size */
        }

        /* Snake Styles */
        .snake-segment {
            background: #4CAF50 !important;
            border-radius: 50%;
            border: 1px solid #2E7D32 !important;
            z-index: 2;
            transform: scale(0.92);
        }

        .snake-head {
            background: #388E3C !important;
            z-index: 3;
            border-radius: 50%;
            transform: scale(1);
            position: relative;
        }
        .snake-head::before, .snake-head::after {
            content: ''; position: absolute; top: 20%; width: 25%; height: 25%; background: white; border-radius: 50%;
        }
        .snake-head::before { left: 20%; }
        .snake-head::after { right: 20%; }

        .score-float {
            position: absolute;
            top: 0px;
            right: 0px;
            background: rgba(255,255,255,0.9);
            padding: 0.4rem 0.8rem;
            border-radius: 0 0 0 15px;
            font-weight: bold;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.1);
            font-size: 1rem;
            z-index: 5;
            pointer-events: none;
        }

        /* --- MOBILE D-PAD --- */
        .mobile-controls {
            display: none; /* Hidden on desktop */
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 50px 50px;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .d-pad-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #ccc;
            border-radius: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 0 #bbb;
            user-select: none;
            cursor: pointer;
        }

        .d-pad-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #bbb;
            background: #e3f2fd;
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }

        .modal-box {
            background: white;
            padding: 1.5rem;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 85%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: popIn 0.4s;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-title { font-size: 2rem; margin-bottom: 0.5rem; color: #333; font-weight: 800; }
        .modal-text { font-size: 1.1rem; color: #555; margin-bottom: 1.5rem; }
        
        .btn-primary {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #2E7D32;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 2px 0 #2E7D32; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 800px) {
            /* Mobile Layout: Column Reverse to put legend at bottom */
            .game-container { 
                flex-direction: column; 
                gap: 0.5rem; 
                justify-content: space-between;
            }
            
            /* Sidebar becomes a small horizontal/vertical legend at bottom */
            .sidebar { 
                width: 100%; 
                height: auto; 
                max-height: 120px;
                order: 3; /* Sidebar at the bottom */
                border: none;
                background: rgba(255,255,255,0.6);
            }
            .sidebar-header { padding: 0.4rem; font-size: 0.8rem; }
            .sidebar-content {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
                padding: 0.3rem;
            }
            .mini-legend-item { 
                border: 1px solid #ddd; 
                background: white; 
                border-radius: 8px; 
                padding: 0.2rem 0.5rem; 
                font-size: 0.75rem;
            }
            
            .game-area {
                order: 2; /* Game board in middle */
                justify-content: flex-start;
                flex: 1;
                /* Ensure space for d-pad */
            }

            .mobile-controls {
                display: grid; /* Show D-Pad on mobile */
            }

            /* Adjust Modal for Phone */
            .modal-title { font-size: 1.6rem; }
            .modal-text { font-size: 0.95rem; }
            .btn-primary { font-size: 1.1rem; padding: 0.6rem 1.8rem; }
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
 </head>
 <body>

  <div id="app">
    
   <!-- 1. Header & Controls -->
   <div class="header-section" id="headerSection">
       <div class="question-bar">
           <h1 class="question-text" id="questionText">Apakah fungsi telefon pintar?</h1>
       </div>
       <div class="controls-bar">
           
           <!-- Speed Selector -->
           <select id="speedSelect" class="btn-small" onchange="changeSpeed(this.value)" title="Laraskan Kelajuan">
               <option value="350">üêå Santai</option>
               <option value="200" selected>üêõ Biasa</option>
               <option value="100">üöÄ Laju</option>
           </select>

           <!-- Controls -->
           <button class="btn-small btn-restart" onclick="showMainMenu()">
               <span>‚Üª</span> Mula Semula
           </button>
           <button class="btn-small btn-fullscreen" onclick="toggleFullScreen()">
               <span>‚õ∂</span> Skrin Penuh
           </button>
       </div>
   </div>

   <!-- 2. Main Layout -->
   <div class="game-container">
       
       <!-- Left Sidebar: Legend -->
       <div class="sidebar">
           <div class="sidebar-header">üìù Panduan Simbol</div>
           <div class="sidebar-content" id="sidebarLegend">
               <!-- Populated by JS -->
           </div>
       </div>

       <!-- Center: Game Board & Mobile Controls -->
       <div class="game-area" id="gameArea">
           <div class="score-float" id="scorePanel">Skor: 0</div>
           
           <div class="game-board" id="gameBoard">
               <div class="grid-container" id="gridContainer"></div>
           </div>

           <!-- Mobile D-Pad -->
           <div class="mobile-controls">
               <div style="grid-column: 2; grid-row: 1;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('up', event)">‚¨ÜÔ∏è</button>
               </div>
               <div style="grid-column: 1; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('left', event)">‚¨ÖÔ∏è</button>
               </div>
               <div style="grid-column: 2; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('down', event)">‚¨áÔ∏è</button>
               </div>
               <div style="grid-column: 3; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('right', event)">‚û°Ô∏è</button>
               </div>
           </div>
       </div>

   </div>

   <!-- START OVERLAY -->
   <div class="overlay active" id="startOverlay">
       <div class="modal-box">
           <h2 class="modal-title">üêõ Captain Pillar</h2>
           <p class="modal-text">
               Gunakan kekunci panah ‚å®Ô∏è<br>atau gerakkan jari (swipe) üëÜ untuk bermain.<br><br>
               <strong>Misi:</strong> Cari jawapan yang betul!
           </p>
           <div class="legend-list" id="legendAll" style="display: none;"></div> <!-- Hidden ref -->
           <button class="btn-primary" onclick="startGameSession()">MULA ‚ñ∂</button>
       </div>
   </div>

   <!-- WIN OVERLAY -->
   <div class="overlay" id="celebrationOverlay">
    <div class="modal-box">
     <div style="font-size: 4rem; margin-bottom: 0.5rem;">üéâüèÜüéâ</div>
     <h2 class="modal-title">Tahniah!</h2>
     <p class="modal-text" id="finalScoreWin">Semua jawapan ditemui!</p>
     <button class="btn-primary" onclick="showMainMenu()">MAIN LAGI ‚Üª</button>
    </div>
   </div>

   <!-- LOSE OVERLAY -->
   <div class="overlay" id="wrongAnswerOverlay">
    <div class="modal-box">
     <div style="font-size: 4rem; margin-bottom: 0.5rem;">üò¢üí•</div>
     <h2 class="modal-title">Tamat</h2>
     <p class="modal-text" id="finalScoreLose">Terlanggar!</p>
     <button class="btn-primary" onclick="showMainMenu()">CUBA LAGI ‚Üª</button>
    </div>
   </div>

  </div>

  <script>
        // --- CONFIG & DATA ---
        let config = {
            gridCols: 25, // Default Landscape
            gridRows: 18, 
            speed: 200
        };

        const correctAnswersData = [
            { id: 'belajar', icon: 'üìö', label: 'Belajar' },
            { id: 'info', icon: 'üîç', label: 'Cari Info' },
            { id: 'call', icon: 'üìû', label: 'Telefon' },
            { id: 'foto', icon: 'üì∑', label: 'Ambil Foto' },
            { id: 'masa', icon: '‚è∞', label: 'Masa/Alarm' },
            { id: 'maps', icon: 'üó∫Ô∏è', label: 'Peta' },
            { id: 'buku', icon: 'üìñ', label: 'E-Buku' },
            { id: 'kalendar', icon: 'üìÖ', label: 'Kalendar' },
            { id: 'hiburan', icon: 'üéµ', label: 'Muzik' },
            { id: 'bank', icon: 'üí∏', label: 'Bank Online' }
        ];

        const wrongAnswersData = [
            { icon: 'üëï', label: 'Gosok Baju' },
            { icon: 'üçö', label: 'Makan Nasi' },
            { icon: 'üò¥', label: 'Tidur' },
            { icon: 'üé£', label: 'Memancing' },
            { icon: 'üç≥', label: 'Masak' },
            { icon: 'üßÖ', label: 'Kupas Bawang' },
            { icon: 'üöø', label: 'Mandi' },
            { icon: 'üå±', label: 'Tanam Pokok' },
            { icon: 'üöó', label: 'Cuci Kereta' },
            { icon: 'üßπ', label: 'Menyapu' }
        ];

        // --- STATE ---
        let snake = [];
        let direction = {x: 1, y: 0};
        let nextDirection = {x: 1, y: 0};
        let score = 0;
        let gameInterval;
        let isGameRunning = false;
        let activeCorrectAnswers = [];
        let activeWrongAnswers = [];
        let collectedIds = new Set();
        let cellSize = 20;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const now = audioCtx.currentTime;
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'eat') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'win') {
                [440, 554, 659].forEach((f, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.4); o.start(now); o.stop(now+0.4); });
            }
        }

        // --- ADAPTIVE GRID & RESIZING LOGIC ---
        
        function detectOrientationAndSetGrid() {
            // Check if we are in portrait mode (taller than wide)
            const isPortrait = window.innerHeight > window.innerWidth;
            
            // Only update if dimensions change significantly to avoid reset on minor resize
            if (isPortrait) {
                // Phone/Portrait mode
                config.gridCols = 15;
                config.gridRows = 22;
            } else {
                // Desktop/Landscape mode
                config.gridCols = 25;
                config.gridRows = 18;
            }
        }

        function resizeBoard() {
            const gameArea = document.getElementById('gameArea');
            const dPad = document.querySelector('.mobile-controls');
            
            // Calculate available height
            let availHeight = gameArea.clientHeight;
            
            // If D-Pad is visible (mobile), subtract its height
            if (getComputedStyle(dPad).display !== 'none') {
                availHeight -= (dPad.offsetHeight + 20); // 20px padding margin
            }

            const availWidth = gameArea.clientWidth;

            // Calculate max cell size to fill space as much as possible
            const maxW = (availWidth - 4) / config.gridCols; // -4 for border safety
            const maxH = (availHeight - 4) / config.gridRows;
            
            cellSize = Math.floor(Math.min(maxW, maxH));
            
            const gridContainer = document.getElementById('gridContainer');
            // Explicitly set rows and cols
            gridContainer.style.gridTemplateColumns = `repeat(${config.gridCols}, ${cellSize}px)`;
            gridContainer.style.gridTemplateRows = `repeat(${config.gridRows}, ${cellSize}px)`;
            
            gridContainer.style.width = `${config.gridCols * cellSize}px`;
            gridContainer.style.height = `${config.gridRows * cellSize}px`;
            
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(c => {
                c.style.width = `${cellSize}px`;
                c.style.height = `${cellSize}px`;
                c.style.fontSize = `${cellSize * 0.7}px`;
            });
        }

        window.addEventListener('resize', () => {
            // Note: We don't change grid dimensions on simple resize to prevent game reset
            // But we do resize the cells
            resizeBoard();
        });

        // --- INIT ---
        function initGrid() {
            detectOrientationAndSetGrid(); // Set initial grid size based on screen
            
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            for (let i = 0; i < config.gridCols * config.gridRows; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                container.appendChild(cell);
            }
            setTimeout(resizeBoard, 50);
        }

        function populateSidebar() {
            const sidebar = document.getElementById('sidebarLegend');
            sidebar.innerHTML = '';
            const allItems = [...correctAnswersData, ...wrongAnswersData];
            allItems.sort((a, b) => a.label.localeCompare(b.label));
            allItems.forEach(item => {
                sidebar.innerHTML += `
                    <div class="mini-legend-item">
                        <span class="mini-legend-icon">${item.icon}</span>
                        <span>${item.label}</span>
                    </div>
                `;
            });
        }

        // --- TOUCH / SWIPE LOGIC ---
        let touchStartX = 0;
        let touchStartY = 0;

        document.getElementById('gameBoard').addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false});

        document.getElementById('gameBoard').addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevent scroll while playing
        }, {passive: false});

        document.getElementById('gameBoard').addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
        }, {passive: false});

        function handleSwipe(startX, startY, endX, endY) {
            if (!isGameRunning) return;
            const diffX = endX - startX;
            const diffY = endY - startY;

            // Minimum swipe distance
            if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                // Horizontal
                if (diffX > 0 && direction.x === 0) nextDirection = {x: 1, y: 0};
                else if (diffX < 0 && direction.x === 0) nextDirection = {x: -1, y: 0};
            } else {
                // Vertical
                if (diffY > 0 && direction.y === 0) nextDirection = {x: 0, y: 1};
                else if (diffY < 0 && direction.y === 0) nextDirection = {x: 0, y: -1};
            }
        }

        // --- D-PAD LOGIC ---
        function handleDPad(dir, e) {
            e.preventDefault(); // Prevent focus/zoom
            if (!isGameRunning) return;

            switch(dir) {
                case 'up': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'down': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'left': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'right': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        }

        // --- GAME CONTROL ---
        function changeSpeed(val) {
            config.speed = parseInt(val);
            if (isGameRunning) {
                clearInterval(gameInterval);
                gameInterval = setInterval(gameLoop, config.speed);
                document.activeElement.blur(); 
            }
        }

        function showMainMenu() {
            isGameRunning = false;
            clearInterval(gameInterval);
            document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
            document.getElementById('startOverlay').classList.add('active');
        }

        function startGameSession() {
            document.getElementById('startOverlay').classList.remove('active');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resetGame();
        }

        function resetGame() {
            document.querySelectorAll('.overlay').forEach(el => {
                if(el.id !== 'startOverlay') el.classList.remove('active');
            });

            // Re-detect orientation on restart to adapt to rotation changes properly
            detectOrientationAndSetGrid();
            // Re-init grid in case dimensions changed
            initGrid();

            snake = [{x: 5, y: 5}, {x: 4, y: 5}, {x: 3, y: 5}];
            direction = {x: 1, y: 0};
            nextDirection = {x: 1, y: 0};
            score = 0;
            collectedIds.clear();
            isGameRunning = true;

            const speedSelect = document.getElementById('speedSelect');
            config.speed = parseInt(speedSelect.value);

            generateItems();
            updateScoreDisplay();
            resizeBoard();
            renderBoard();
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, config.speed);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(err);
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
            // Trigger resize after slight delay to allow transition
            setTimeout(resizeBoard, 200);
        }

        // --- GAME LOGIC ---
        function generateItems() {
            activeCorrectAnswers = [];
            activeWrongAnswers = [];
            const usedPositions = new Set();
            snake.forEach(s => usedPositions.add(`${s.x},${s.y}`));

            const getRandomPos = () => {
                let x, y, key;
                do {
                    x = Math.floor(Math.random() * config.gridCols);
                    y = Math.floor(Math.random() * config.gridRows);
                    key = `${x},${y}`;
                } while (usedPositions.has(key));
                usedPositions.add(key);
                return {x, y};
            };

            correctAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeCorrectAnswers.push({ ...pos, data: item });
            });
            wrongAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeWrongAnswers.push({ ...pos, icon: item.icon });
            });
        }

        function renderBoard() {
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(cell => {
                cell.textContent = '';
                cell.className = 'grid-cell';
                cell.style.opacity = '1';
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                cell.style.fontSize = `${cellSize * 0.7}px`;
            });

            activeCorrectAnswers.forEach(item => {
                if (collectedIds.has(item.data.id)) return;
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) cells[idx].textContent = item.data.icon;
            });

            activeWrongAnswers.forEach(item => {
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) {
                    cells[idx].textContent = item.icon;
                    cells[idx].style.opacity = '0.6';
                }
            });

            snake.forEach((seg, i) => {
                const idx = seg.y * config.gridCols + seg.x;
                if (cells[idx]) {
                    cells[idx].classList.add(i === 0 ? 'snake-head' : 'snake-segment');
                    cells[idx].textContent = ''; 
                }
            });
        }

        function gameLoop() {
            if (!isGameRunning) return;

            direction = nextDirection;
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (head.x < 0) head.x = config.gridCols - 1;
            if (head.x >= config.gridCols) head.x = 0;
            if (head.y < 0) head.y = config.gridRows - 1;
            if (head.y >= config.gridRows) head.y = 0;

            if (snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver(false);
                return;
            }

            snake.unshift(head);
            let ateFood = false;

            const correctIdx = activeCorrectAnswers.findIndex(
                item => !collectedIds.has(item.data.id) && item.x === head.x && item.y === head.y
            );

            if (correctIdx !== -1) {
                collectedIds.add(activeCorrectAnswers[correctIdx].data.id);
                score += 10;
                playSound('eat');
                document.getElementById('gameBoard').classList.add('flash-correct');
                setTimeout(() => document.getElementById('gameBoard').classList.remove('flash-correct'), 300);
                ateFood = true;

                if (collectedIds.size === correctAnswersData.length) {
                    gameOver(true);
                    return;
                }
            }

            const wrongIdx = activeWrongAnswers.findIndex(
                item => item.x === head.x && item.y === head.y
            );

            if (wrongIdx !== -1) {
                score = Math.max(0, score - 5);
                playSound('wrong');
                document.getElementById('gameBoard').classList.add('flash-wrong');
                setTimeout(() => document.getElementById('gameBoard').classList.remove('flash-wrong'), 300);
                activeWrongAnswers.splice(wrongIdx, 1);
                if (snake.length > 2) snake.pop();
            }

            if (!ateFood) snake.pop();
            updateScoreDisplay();
            renderBoard();
        }

        function updateScoreDisplay() {
            document.getElementById('scorePanel').innerText = `Skor: ${score}`;
        }

        function gameOver(win) {
            isGameRunning = false;
            clearInterval(gameInterval);
            playSound(win ? 'win' : 'wrong');
            
            if (win) {
                document.getElementById('finalScoreWin').innerText = `Markah Akhir: ${score}`;
                document.getElementById('celebrationOverlay').classList.add('active');
            } else {
                document.getElementById('finalScoreLose').innerText = `Markah Akhir: ${score}`;
                document.getElementById('wrongAnswerOverlay').classList.add('active');
            }
        }

        document.addEventListener('keydown', e => {
            if (!isGameRunning) return;
            switch(e.key) {
                case 'ArrowUp': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'ArrowDown': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'ArrowLeft': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'ArrowRight': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        });

        initGrid();
        populateSidebar();
    </script>
 </body>
</html>
