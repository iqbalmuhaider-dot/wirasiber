<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Captain Pillar</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', cursive, sans-serif;
            overflow: hidden; /* No scroll on body */
            background-color: #87CEEB;
            height: 100vh;
            width: 100vw;
        }

        #app {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            box-sizing: border-box;
            position: relative;
        }

        /* --- HEADER SECTION --- */
        .header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            z-index: 10;
        }

        .question-bar {
            padding: 0.6rem 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            background: #FFD700;
            width: 100%;
            max-width: 800px;
        }

        .question-text {
            font-size: clamp(1.2rem, 4vw, 1.8rem); /* Responsive text size */
            font-weight: bold;
            margin: 0;
            color: #333;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4);
        }

        .controls-bar {
            display: flex;
            gap: 1rem;
        }

        .btn-small {
            background: white;
            border: 2px solid #ddd;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .btn-small:hover { transform: translateY(-2px); }
        .btn-small:active { transform: translateY(0); }

        .btn-restart { color: #d32f2f; border-color: #ffcdd2; background: #ffebee; }
        .btn-fullscreen { color: #1976d2; border-color: #bbdefb; background: #e3f2fd; }

        /* --- MAIN GAME LAYOUT --- */
        .game-container {
            flex: 1;
            display: flex;
            overflow: hidden; /* Prevent scrolling inside container */
            gap: 1rem;
            justify-content: center;
            align-items: flex-start;
            height: 100%;
        }

        /* LEFT SIDEBAR (Legend) */
        .sidebar {
            width: 220px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 95%; /* Fit within container */
            border: 2px solid #fff;
        }

        .sidebar-header {
            background: #f0f4f8;
            padding: 0.8rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 0.95rem;
            color: #444;
        }

        .sidebar-content {
            overflow-y: auto;
            padding: 0.5rem;
            flex: 1;
        }

        .mini-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .mini-legend-item:last-child { border-bottom: none; }
        .mini-legend-icon { font-size: 1.2rem; min-width: 25px; text-align: center; }

        /* CENTER GAME AREA */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
        }

        .game-board {
            background: #FFFFFF;
            border: 4px solid #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            /* Size controlled by JS */
        }

        .game-board.flash-correct { animation: flashBlue 0.5s ease; }
        .game-board.flash-wrong { animation: flashRed 0.5s ease; }

        @keyframes flashBlue { 0%, 100% { border-color: #fff; } 50% { border-color: #2196F3; } }
        @keyframes flashRed { 0%, 100% { border-color: #fff; } 50% { border-color: #F44336; } }

        .grid-container {
            display: grid;
            /* Grid Template set by JS */
        }

        .grid-cell {
            background-color: #F8F9FA;
            border: 1px solid #EEEEEE;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Font size scaled by JS */
            line-height: 1;
        }

        /* Snake Styles */
        .snake-segment {
            background: #4CAF50 !important;
            border-radius: 50%;
            border: 1px solid #2E7D32 !important;
            z-index: 2;
            transform: scale(0.92);
        }

        .snake-head {
            background: #388E3C !important;
            z-index: 3;
            border-radius: 50%;
            transform: scale(1);
            position: relative;
        }
        /* Eyes */
        .snake-head::before, .snake-head::after {
            content: ''; position: absolute; top: 20%; width: 25%; height: 25%; background: white; border-radius: 50%;
        }
        .snake-head::before { left: 20%; }
        .snake-head::after { right: 20%; }

        .score-float {
            position: absolute;
            top: 0px;
            right: 0px;
            background: rgba(255,255,255,0.9);
            padding: 0.5rem 1rem;
            border-radius: 0 0 0 15px;
            font-weight: bold;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.1);
            font-size: 1.1rem;
            z-index: 5;
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }

        .modal-box {
            background: white;
            padding: 2rem;
            border-radius: 30px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: popIn 0.4s;
        }

        .modal-title { font-size: 2.5rem; margin-bottom: 0.5rem; color: #333; font-weight: 800; }
        .modal-text { font-size: 1.2rem; color: #555; margin-bottom: 2rem; }
        
        .btn-primary {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.8rem 2.5rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #2E7D32;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 2px 0 #2E7D32; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* RESPONSIVE */
        @media (max-width: 800px) {
            .game-container { flex-direction: column-reverse; gap: 0.5rem; }
            .sidebar { 
                width: 100%; 
                height: 120px; /* Short height for mobile legend */
                flex-shrink: 0;
            }
            .sidebar-content {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: center;
            }
            .mini-legend-item { border-bottom: none; border-right: 1px solid #eee; padding-right: 1rem; }
            .score-float { font-size: 0.9rem; padding: 0.3rem 0.8rem; }
        }
    </style>
 </head>
 <body>

  <div id="app">
    
   <!-- 1. Header & Controls -->
   <div class="header-section" id="headerSection">
       <div class="question-bar">
           <h1 class="question-text" id="questionText">Apakah fungsi telefon pintar?</h1>
       </div>
       <div class="controls-bar">
           <!-- Changed onclick to showMainMenu() -->
           <button class="btn-small btn-restart" onclick="showMainMenu()">
               <span>‚Üª</span> Mula Semula
           </button>
           <button class="btn-small btn-fullscreen" onclick="toggleFullScreen()">
               <span>‚õ∂</span> Skrin Penuh
           </button>
       </div>
   </div>

   <!-- 2. Main Layout -->
   <div class="game-container">
       
       <!-- Left Sidebar: Legend -->
       <div class="sidebar">
           <div class="sidebar-header">üìù Panduan Simbol</div>
           <div class="sidebar-content" id="sidebarLegend">
               <!-- Populated by JS -->
           </div>
       </div>

       <!-- Center: Game Board -->
       <div class="game-area" id="gameArea">
           <div class="score-float" id="scorePanel">Skor: 0</div>
           <div class="game-board" id="gameBoard">
               <div class="grid-container" id="gridContainer"></div>
           </div>
       </div>

   </div>

   <!-- START OVERLAY -->
   <div class="overlay active" id="startOverlay">
       <div class="modal-box">
           <h2 class="modal-title">üêõ Captain Pillar</h2>
           <p class="modal-text">
               Gunakan kekunci panah ‚å®Ô∏è untuk bergerak.<br>
               <strong>Misi:</strong> Cari jawapan yang betul di papan permainan!
           </p>
           <button class="btn-primary" onclick="startGameSession()">MULA ‚ñ∂</button>
       </div>
   </div>

   <!-- WIN OVERLAY -->
   <div class="overlay" id="celebrationOverlay">
    <div class="modal-box">
     <div style="font-size: 4rem; margin-bottom: 0.5rem;">üéâüèÜüéâ</div>
     <h2 class="modal-title">Tahniah!</h2>
     <p class="modal-text" id="finalScoreWin">Semua jawapan ditemui!</p>
     <button class="btn-primary" onclick="showMainMenu()">MAIN LAGI ‚Üª</button>
    </div>
   </div>

   <!-- LOSE OVERLAY -->
   <div class="overlay" id="wrongAnswerOverlay">
    <div class="modal-box">
     <div style="font-size: 4rem; margin-bottom: 0.5rem;">üò¢üí•</div>
     <h2 class="modal-title">Tamat</h2>
     <p class="modal-text" id="finalScoreLose">Terlanggar!</p>
     <button class="btn-primary" onclick="showMainMenu()">CUBA LAGI ‚Üª</button>
    </div>
   </div>

  </div>

  <script>
        // --- CONFIG & DATA ---
        const config = {
            gridCols: 25,
            gridRows: 18,
            speed: 200 // ms
        };

        const correctAnswersData = [
            { id: 'belajar', icon: 'üìö', label: 'Belajar' },
            { id: 'info', icon: 'üîç', label: 'Cari Info' },
            { id: 'call', icon: 'üìû', label: 'Telefon' },
            { id: 'foto', icon: 'üì∑', label: 'Ambil Foto' },
            { id: 'masa', icon: '‚è∞', label: 'Masa' },
            { id: 'maps', icon: 'üó∫Ô∏è', label: 'Peta' },
            { id: 'buku', icon: 'üìñ', label: 'E-Buku' },
            { id: 'kalendar', icon: 'üìÖ', label: 'Kalendar' },
            { id: 'hiburan', icon: 'üéµ', label: 'Muzik' },
            { id: 'bank', icon: 'üè¶', label: 'Bank' }
        ];

        const wrongAnswersData = [
            { icon: 'üëï', label: 'Gosok Baju' },
            { icon: 'üçö', label: 'Makan Nasi' },
            { icon: 'üò¥', label: 'Tidur' },
            { icon: 'üé£', label: 'Mancing' },
            { icon: 'üç≥', label: 'Masak' },
            { icon: '‚öΩ', label: 'Bola' },
            { icon: 'üöø', label: 'Mandi' },
            { icon: 'üåø', label: 'Rumput' },
            { icon: 'üöó', label: 'Cuci Kereta' },
            { icon: 'üßπ', label: 'Sapu' }
        ];

        // --- STATE ---
        let snake = [];
        let direction = {x: 1, y: 0};
        let nextDirection = {x: 1, y: 0};
        let score = 0;
        let gameInterval;
        let isGameRunning = false;
        let activeCorrectAnswers = [];
        let activeWrongAnswers = [];
        let collectedIds = new Set();
        let cellSize = 20; // Will be dynamic

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const now = audioCtx.currentTime;
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'eat') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'win') {
                [440, 554, 659].forEach((f, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type='square'; o.frequency.value=f;
                    g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.4);
                    o.start(now); o.stop(now+0.4);
                });
            }
        }

        // --- RESIZING LOGIC (Fit Screen) ---
        function resizeBoard() {
            const gameArea = document.getElementById('gameArea');
            const containerW = gameArea.clientWidth;
            const containerH = gameArea.clientHeight;

            // Calculate max cell size that fits in container
            // Allow small margin
            const maxW = (containerW - 20) / config.gridCols;
            const maxH = (containerH - 20) / config.gridRows;
            
            cellSize = Math.floor(Math.min(maxW, maxH));
            
            // Apply size
            const gridContainer = document.getElementById('gridContainer');
            gridContainer.style.gridTemplateColumns = `repeat(${config.gridCols}, ${cellSize}px)`;
            gridContainer.style.width = `${config.gridCols * cellSize}px`;
            
            // Adjust cell heights
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(c => {
                c.style.width = `${cellSize}px`;
                c.style.height = `${cellSize}px`;
                c.style.fontSize = `${cellSize * 0.7}px`; // Scale icons
            });
        }

        window.addEventListener('resize', resizeBoard);

        // --- INIT & POPULATE ---
        function initGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            for (let i = 0; i < config.gridCols * config.gridRows; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                container.appendChild(cell);
            }
            // Trigger resize after creating cells
            setTimeout(resizeBoard, 50);
        }

        function populateSidebar() {
            const sidebar = document.getElementById('sidebarLegend');
            sidebar.innerHTML = '';
            
            const allItems = [...correctAnswersData, ...wrongAnswersData];
            allItems.sort((a, b) => a.label.localeCompare(b.label));

            allItems.forEach(item => {
                sidebar.innerHTML += `
                    <div class="mini-legend-item">
                        <span class="mini-legend-icon">${item.icon}</span>
                        <span>${item.label}</span>
                    </div>
                `;
            });
        }

        // --- GAME CONTROL ---
        function showMainMenu() {
            // Stop the game loop
            isGameRunning = false;
            clearInterval(gameInterval);
            
            // Show main menu overlay
            document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
            document.getElementById('startOverlay').classList.add('active');
        }

        function startGameSession() {
            document.getElementById('startOverlay').classList.remove('active');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resetGame();
        }

        function resetGame() {
            document.querySelectorAll('.overlay').forEach(el => {
                if(el.id !== 'startOverlay') el.classList.remove('active');
            });

            snake = [{x: 5, y: 5}, {x: 4, y: 5}, {x: 3, y: 5}];
            direction = {x: 1, y: 0};
            nextDirection = {x: 1, y: 0};
            score = 0;
            collectedIds.clear();
            isGameRunning = true;

            generateItems();
            updateScoreDisplay();
            resizeBoard(); // Ensure fit
            renderBoard(); // Draw initial state
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, config.speed);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- GAME LOGIC ---
        function generateItems() {
            activeCorrectAnswers = [];
            activeWrongAnswers = [];
            const usedPositions = new Set();
            snake.forEach(s => usedPositions.add(`${s.x},${s.y}`));

            const getRandomPos = () => {
                let x, y, key;
                do {
                    x = Math.floor(Math.random() * config.gridCols);
                    y = Math.floor(Math.random() * config.gridRows);
                    key = `${x},${y}`;
                } while (usedPositions.has(key));
                usedPositions.add(key);
                return {x, y};
            };

            correctAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeCorrectAnswers.push({ ...pos, data: item });
            });

            wrongAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeWrongAnswers.push({ ...pos, icon: item.icon });
            });
        }

        function renderBoard() {
            const cells = document.querySelectorAll('.grid-cell');
            
            // Faster clear (text content only)
            cells.forEach(cell => {
                cell.textContent = '';
                cell.className = 'grid-cell';
                cell.style.opacity = '1';
                // Re-apply size in case of resize glitch, though resizing handles it
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                cell.style.fontSize = `${cellSize * 0.7}px`;
            });

            activeCorrectAnswers.forEach(item => {
                if (collectedIds.has(item.data.id)) return;
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) cells[idx].textContent = item.data.icon;
            });

            activeWrongAnswers.forEach(item => {
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) {
                    cells[idx].textContent = item.icon;
                    cells[idx].style.opacity = '0.6';
                }
            });

            snake.forEach((seg, i) => {
                const idx = seg.y * config.gridCols + seg.x;
                if (cells[idx]) {
                    cells[idx].classList.add(i === 0 ? 'snake-head' : 'snake-segment');
                    cells[idx].textContent = ''; 
                }
            });
        }

        function gameLoop() {
            if (!isGameRunning) return;

            direction = nextDirection;
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // Wrap Walls
            if (head.x < 0) head.x = config.gridCols - 1;
            if (head.x >= config.gridCols) head.x = 0;
            if (head.y < 0) head.y = config.gridRows - 1;
            if (head.y >= config.gridRows) head.y = 0;

            // Self Collision
            if (snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver(false);
                return;
            }

            snake.unshift(head);
            let ateFood = false;

            // Check Correct Answer
            const correctIdx = activeCorrectAnswers.findIndex(
                item => !collectedIds.has(item.data.id) && item.x === head.x && item.y === head.y
            );

            if (correctIdx !== -1) {
                collectedIds.add(activeCorrectAnswers[correctIdx].data.id);
                score += 10;
                playSound('eat');
                document.getElementById('gameBoard').classList.add('flash-correct');
                setTimeout(() => document.getElementById('gameBoard').classList.remove('flash-correct'), 300);
                ateFood = true;

                if (collectedIds.size === correctAnswersData.length) {
                    gameOver(true);
                    return;
                }
            }

            // Check Wrong Answer
            const wrongIdx = activeWrongAnswers.findIndex(
                item => item.x === head.x && item.y === head.y
            );

            if (wrongIdx !== -1) {
                score = Math.max(0, score - 5);
                playSound('wrong');
                document.getElementById('gameBoard').classList.add('flash-wrong');
                setTimeout(() => document.getElementById('gameBoard').classList.remove('flash-wrong'), 300);
                activeWrongAnswers.splice(wrongIdx, 1);
                
                if (snake.length > 2) snake.pop();
            }

            if (!ateFood) snake.pop();

            updateScoreDisplay();
            renderBoard();
        }

        function updateScoreDisplay() {
            document.getElementById('scorePanel').innerText = `Skor: ${score}`;
        }

        function gameOver(win) {
            isGameRunning = false;
            clearInterval(gameInterval);
            playSound(win ? 'win' : 'wrong');
            
            if (win) {
                document.getElementById('finalScoreWin').innerText = `Markah Akhir: ${score}`;
                document.getElementById('celebrationOverlay').classList.add('active');
            } else {
                document.getElementById('finalScoreLose').innerText = `Markah Akhir: ${score}`;
                document.getElementById('wrongAnswerOverlay').classList.add('active');
            }
        }

        document.addEventListener('keydown', e => {
            if (!isGameRunning) return;
            switch(e.key) {
                case 'ArrowUp': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'ArrowDown': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'ArrowLeft': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'ArrowRight': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        });

        // Start
        initGrid();
        populateSidebar();
    </script>
 </body>
</html>
