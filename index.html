<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Captain Pillar - Peranti Digital</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        /* --- RESET & BASIC SETUP --- */
        * {
            box-sizing: border-box;
            touch-action: none; /* Disable default browser touch actions */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', cursive, sans-serif;
            overflow: hidden; /* STRICT NO SCROLL */
            background-color: #87CEEB;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
        }

        #app {
            height: 100%;
            width: 100%;
            max-width: 1200px; /* Limit max width on huge screens */
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            position: relative;
        }

        /* --- 1. SCHOOL HEADER (Compact) --- */
        .school-header {
            flex-shrink: 0; /* Don't shrink below content size */
            text-align: center;
            margin-bottom: 0.3rem;
            color: #1565C0;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px; /* Fixed height for consistency */
        }
        
        .school-name {
            font-size: clamp(0.9rem, 2.5vw, 1.4rem);
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .school-logo-img {
            height: 45px;
            width: auto;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.1));
        }

        /* --- 2. GAME CONTROLS HEADER (Compact) --- */
        .header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.3rem;
            z-index: 10;
        }

        .question-bar {
            padding: 0.3rem 1rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.12);
            background: #FFD700;
            width: 100%;
            max-width: 600px;
        }

        .question-text {
            font-size: clamp(0.9rem, 3vw, 1.4rem);
            font-weight: bold;
            margin: 0;
            color: #333;
            line-height: 1.1;
        }

        .controls-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-small {
            background: white;
            border: 1px solid #ccc;
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.1s;
            outline: none;
        }

        .btn-small:active { transform: translateY(1px); }
        .btn-restart { color: #d32f2f; background: #ffebee; }
        .btn-pause { color: #f57c00; background: #fff3e0; }
        .btn-fullscreen { color: #1976d2; background: #e3f2fd; }

        /* --- 3. MAIN GAME CONTAINER (Flexible) --- */
        .game-container {
            flex: 1; /* Takes remaining height */
            display: flex;
            overflow: hidden; 
            gap: 0.5rem;
            justify-content: center;
            align-items: stretch;
            min-height: 0; /* Important for flex child scrolling/fitting */
        }

        /* LEFT SIDEBAR (Legend) */
        .sidebar {
            width: 180px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #fff;
            flex-shrink: 0;
        }

        .sidebar-header {
            background: #f0f4f8;
            padding: 0.4rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            font-size: 0.85rem;
            color: #444;
        }

        .sidebar-content {
            overflow-y: auto;
            padding: 0.3rem;
            flex: 1;
        }

        .mini-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem;
            border-bottom: 1px solid #eee;
            font-size: 0.75rem;
            line-height: 1.1;
        }
        
        .mini-legend-icon { font-size: 1.1rem; min-width: 20px; text-align: center; }
        .legend-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #666;
            margin: 0.3rem 0 0.1rem 0;
            padding-bottom: 0.1rem;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }

        /* CENTER GAME AREA */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            min-width: 0; /* Allow shrinking */
        }

        .game-board {
            background: #FFFFFF;
            border: 3px solid #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            /* Size controlled by JS */
        }

        .game-board.flash-correct { animation: flashBlue 0.5s ease; }
        .game-board.flash-wrong { animation: flashRed 0.5s ease; }

        @keyframes flashBlue { 0%, 100% { border-color: #fff; } 50% { border-color: #2196F3; } }
        @keyframes flashRed { 0%, 100% { border-color: #fff; } 50% { border-color: #F44336; } }

        .grid-container { display: grid; }

        .grid-cell {
            background-color: #F8F9FA;
            border: 1px solid #EEEEEE;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-sizing: border-box;
        }

        /* Snake Styles */
        .snake-segment {
            background: #4CAF50 !important;
            border-radius: 50%;
            border: 1px solid #2E7D32 !important;
            z-index: 2;
            transform: scale(0.92);
        }

        .snake-head {
            background: #388E3C !important;
            z-index: 3;
            border-radius: 50%;
            transform: scale(1.15);
            position: relative;
            display: flex !important;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .snake-face {
            width: 100%; height: 100%; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .eyes-row { display: flex; gap: 15%; margin-bottom: 5%; width: 65%; justify-content: center; }
        .eye { width: 32%; padding-bottom: 32%; background: white; border-radius: 50%; position: relative; }
        .pupil { position: absolute; top: 25%; right: 25%; width: 50%; height: 50%; background: #333; border-radius: 50%; }
        .mouth { width: 45%; height: 20%; border-bottom: 0.15em solid white; border-radius: 0 0 50% 50%; margin-top: -5%; }
        .cheek { position: absolute; top: 55%; width: 22%; height: 15%; background: #FF8A80; border-radius: 50%; opacity: 0.6; }
        .cheek-left { left: 5%; } .cheek-right { right: 5%; }

        .score-float {
            position: absolute;
            top: 0; right: 0;
            background: rgba(255,255,255,0.9);
            padding: 0.3rem 0.8rem;
            border-radius: 0 0 0 10px;
            font-weight: 800;
            box-shadow: -1px 1px 5px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            color: #2E7D32;
            z-index: 5;
            pointer-events: none;
            border: 1px solid #4CAF50;
            border-top: none; border-right: none;
        }

        /* --- MOBILE CONTROLS (Compact) --- */
        .mobile-controls {
            display: none;
            grid-template-columns: 50px 50px 50px;
            grid-template-rows: 45px 45px;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
            align-items: center;
            z-index: 20;
            flex-shrink: 0; /* Prevent resizing */
        }

        .d-pad-btn {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 0 #bbb;
            user-select: none; cursor: pointer;
        }
        .d-pad-btn:active { transform: translateY(2px); box-shadow: none; background: #e3f2fd; }

        /* --- TOAST NOTIFICATION --- */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show { opacity: 1; }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }

        .modal-box {
            background: white;
            padding: 1.5rem;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popIn 0.3s;
            max-height: 90vh;
            display: flex; flex-direction: column;
        }

        .modal-title { font-size: 1.8rem; margin: 0 0 0.5rem 0; color: #333; font-weight: 800; }
        .modal-text { font-size: 1rem; color: #555; margin-bottom: 1rem; }
        
        .level-selector-container { margin: 0.5rem 0 1rem 0; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; }
        .level-label { font-weight: bold; color: #555; font-size: 0.9rem; }
        .level-select { padding: 0.6rem 1rem; font-size: 1rem; border-radius: 10px; border: 2px solid #4CAF50; cursor: pointer; outline: none; }

        .btn-primary {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white; font-size: 1.2rem; font-weight: bold; padding: 0.6rem 2rem;
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 0 #2E7D32; transition: transform 0.1s;
            margin-top: auto; /* Push to bottom if flex */
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 1px 0 #2E7D32; }

        /* --- RESPONSIVE LOGIC --- */
        @media (max-width: 800px) {
            /* Mobile Layout: Stack Vertical */
            .game-container { 
                flex-direction: column; 
                gap: 0.3rem; 
            }
            
            /* Sidebar becomes horizontal bar at bottom */
            .sidebar { 
                width: 100%; 
                height: 80px; /* Fixed small height */
                order: 3;
                background: rgba(255,255,255,0.8);
                border: 1px solid #ddd;
            }
            .sidebar-header { display: none; } /* Hide header to save space */
            .sidebar-content {
                display: flex;
                flex-wrap: nowrap; /* Horizontal scroll */
                gap: 0.5rem;
                padding: 0.5rem;
                overflow-x: auto;
            }
            .mini-legend-item { 
                border: 1px solid #ccc; 
                background: white; 
                border-radius: 6px; 
                padding: 0.2rem 0.4rem; 
                font-size: 0.7rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .legend-section-title { display: none; } 
            
            .game-area {
                order: 2;
                justify-content: flex-start; /* Align top */
            }

            /* Show D-Pad on Mobile */
            .mobile-controls { display: grid; }

            .school-logo-img { height: 35px; }
            .school-header { height: 40px; margin-bottom: 0; }
            .question-bar { padding: 0.3rem 0.5rem; }
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
 </head>
 <body>

  <div id="app">
    
   <!-- TOAST NOTIFICATION -->
   <div id="toast" class="toast">üéÆ Controller Disambung!</div>

   <!-- 1. School Header -->
   <div class="school-header">
       <div class="school-name">
           <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" alt="Logo SKMT" class="school-logo-img">
           SK MASJID TANAH (INTEGRASI)
       </div>
   </div>

   <!-- 2. Header & Controls -->
   <div class="header-section" id="headerSection">
       <div class="question-bar">
           <h1 class="question-text" id="questionText">Jenis-Jenis Peranti Digital?</h1>
       </div>
       <div class="controls-bar">
           <button class="btn-small btn-pause" onclick="togglePause()">
               <span id="pauseBtnIcon">‚è∏Ô∏è</span> Jeda
           </button>
           <button class="btn-small btn-restart" onclick="showMainMenu()">
               <span>‚Üª</span> Menu
           </button>
           <button class="btn-small btn-fullscreen" onclick="toggleFullScreen()">
               <span>‚õ∂</span> Penuh
           </button>
       </div>
   </div>

   <!-- 3. Main Layout -->
   <div class="game-container">
       
       <!-- Left Sidebar: Legend -->
       <div class="sidebar">
           <div class="sidebar-header">üìù Senarai Simbol</div>
           <div class="sidebar-content" id="sidebarLegend">
               <!-- Populated by JS -->
           </div>
       </div>

       <!-- Center: Game Board & Mobile Controls -->
       <div class="game-area" id="gameArea">
           <div class="score-float" id="scorePanel">Markah: 0%</div>
           
           <div class="game-board" id="gameBoard">
               <div class="grid-container" id="gridContainer"></div>
           </div>

           <!-- Mobile D-Pad -->
           <div class="mobile-controls">
               <div style="grid-column: 2; grid-row: 1;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('up', event)">‚¨ÜÔ∏è</button>
               </div>
               <div style="grid-column: 1; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('left', event)">‚¨ÖÔ∏è</button>
               </div>
               <div style="grid-column: 2; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('down', event)">‚¨áÔ∏è</button>
               </div>
               <div style="grid-column: 3; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('right', event)">‚û°Ô∏è</button>
               </div>
           </div>
       </div>

   </div>

   <!-- START OVERLAY -->
   <div class="overlay active" id="startOverlay">
       <div class="modal-box">
           <h2 class="modal-title">üêõ Captain Pillar</h2>
           
           <!-- Question Box -->
           <div style="background: #E3F2FD; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #2196F3;">
               <h3 style="margin: 0; color: #1565C0; font-size: 0.9rem; text-transform: uppercase;">Misi Anda:</h3>
               <p style="margin: 3px 0 0 0; font-weight: 800; font-size: 1.1rem; color: #0D47A1;">
                   Cari "Jenis-Jenis Peranti Digital"
               </p>
           </div>

           <!-- Legend Display -->
           <div style="text-align: left; width: 100%; flex: 1; overflow-y: auto; margin-bottom: 1rem; border: 1px solid #eee; border-radius: 10px; background: #f9f9f9; padding: 8px; min-height: 150px;">
               <div style="font-weight: bold; margin-bottom: 5px; text-align: center; color: #555; font-size: 0.9rem; position: sticky; top: 0; background: #f9f9f9; border-bottom: 1px solid #ddd;">
                   üìñ Panduan Simbol:
               </div>
               <div id="startLegend" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 6px;">
                   <!-- JS will populate -->
               </div>
           </div>
           
           <!-- Level Selector -->
           <div class="level-selector-container">
               <div class="level-label">Pilih Kelajuan:</div>
               <select id="speedSelect" class="level-select">
                   <option value="350">üêå Santai</option>
                   <option value="200" selected>üêõ Biasa</option>
                   <option value="100">üöÄ Laju</option>
               </select>
           </div>

           <button class="btn-primary" onclick="startGameSession()">MULA ‚ñ∂</button>
       </div>
   </div>

   <!-- PAUSE OVERLAY -->
   <div class="overlay" id="pauseOverlay">
       <div class="modal-box" style="height: auto;">
           <h2 class="modal-title">‚è∏Ô∏è Dijeda</h2>
           <p class="modal-text">Permainan berhenti seketika.</p>
           <button class="btn-primary" style="background: #FF9800; box-shadow: 0 4px 0 #E65100;" onclick="togglePause()">SAMBUNG ‚ñ∂</button>
       </div>
   </div>

   <!-- WIN OVERLAY -->
   <div class="overlay" id="celebrationOverlay">
    <div class="modal-box" style="height: auto;">
     <div style="font-size: 3.5rem; margin-bottom: 0.5rem;">üéâüèÜüéâ</div>
     <h2 class="modal-title">Tahniah!</h2>
     <p class="modal-text" id="finalScoreWin">Markah: 100%</p>
     <button class="btn-primary" onclick="showMainMenu()">MENU UTAMA ‚Üª</button>
    </div>
   </div>

   <!-- LOSE OVERLAY -->
   <div class="overlay" id="wrongAnswerOverlay">
    <div class="modal-box" style="height: auto;">
     <div style="font-size: 3.5rem; margin-bottom: 0.5rem;">üò¢üí•</div>
     <h2 class="modal-title">Tamat</h2>
     <p class="modal-text" id="finalScoreLose">Terlanggar!</p>
     <button class="btn-primary" onclick="showMainMenu()">CUBA LAGI ‚Üª</button>
    </div>
   </div>

  </div>

  <script>
        // --- CONFIG & DATA ---
        let config = {
            gridCols: 25, 
            gridRows: 18, 
            speed: 200
        };

        const correctAnswersData = [
            { id: 'smartphone', icon: 'üì±', label: 'Telefon Pintar' },
            { id: 'tablet', icon: 'üì≤', label: 'Tablet' },
            { id: 'desktop', icon: 'üñ•Ô∏è', label: 'Komputer Meja' },
            { id: 'laptop', icon: 'üíª', label: 'Laptop' },
            { id: 'smarttv', icon: 'üì∫', label: 'TV Pintar' },
            { id: 'smartwatch', icon: '‚åö', label: 'Jam Pintar' },
            { id: 'camera', icon: 'üì∑', label: 'Kamera Digital' },
            { id: 'console', icon: 'üéÆ', label: 'Konsol' }
        ];

        const wrongAnswersData = [
            { id: 'typewriter', icon: '‚å®Ô∏è', label: 'Mesin Taip' },
            { id: 'publicphone', icon: '‚òéÔ∏è', label: 'Telefon Awam' },
            { id: 'abacus', icon: 'üßÆ', label: 'Sempoa' },
            { id: 'oldradio', icon: 'üìª', label: 'Radio Lama' },
            { id: 'letter', icon: '‚úâÔ∏è', label: 'Surat' },
            { id: 'newspaper', icon: 'üì∞', label: 'Surat Khabar' },
            { id: 'map', icon: 'üó∫Ô∏è', label: 'Peta Kertas' },
            { id: 'clock', icon: 'üï∞Ô∏è', label: 'Jam Dinding' },
            { id: 'candle', icon: 'üïØÔ∏è', label: 'Lilin' },
            { id: 'fan', icon: 'ü™≠', label: 'Kipas Tangan' }
        ];

        // --- STATE ---
        let snake = [];
        let direction = {x: 1, y: 0};
        let nextDirection = {x: 1, y: 0};
        let gameInterval;
        let isGameRunning = false;
        let isPaused = false;
        let activeCorrectAnswers = [];
        let activeWrongAnswers = [];
        let collectedIds = new Set();
        let eatenIds = new Set();
        let penaltyScore = 0;
        let cellSize = 20;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const now = audioCtx.currentTime;
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'eat') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'win') {
                [440, 554, 659].forEach((f, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.4); o.start(now); o.stop(now+0.4); });
            }
        }

        // --- ADAPTIVE GRID & RESIZING LOGIC ---
        
        function detectOrientationAndSetGrid() {
            const isPortrait = window.innerHeight > window.innerWidth;
            // More conservative grid sizes to ensure fit
            if (isPortrait) {
                config.gridCols = 15;
                config.gridRows = 20; 
            } else {
                config.gridCols = 25;
                config.gridRows = 16;
            }
        }

        function resizeBoard() {
            const gameArea = document.getElementById('gameArea');
            const dPad = document.querySelector('.mobile-controls');
            
            // Calculate available height explicitly
            let availHeight = gameArea.clientHeight;
            
            // Subtract D-Pad height if visible
            if (getComputedStyle(dPad).display !== 'none') {
                availHeight -= (dPad.offsetHeight + 10); 
            }

            const availWidth = gameArea.clientWidth;

            // Calculate max cell size
            // Use Math.floor to ensure integers, prevent sub-pixel blurring/overflow
            const maxW = Math.floor((availWidth - 10) / config.gridCols);
            const maxH = Math.floor((availHeight - 10) / config.gridRows);
            
            cellSize = Math.max(10, Math.min(maxW, maxH)); // Minimum 10px size
            
            const gridContainer = document.getElementById('gridContainer');
            gridContainer.style.gridTemplateColumns = `repeat(${config.gridCols}, ${cellSize}px)`;
            gridContainer.style.gridTemplateRows = `repeat(${config.gridRows}, ${cellSize}px)`;
            gridContainer.style.width = `${config.gridCols * cellSize}px`;
            gridContainer.style.height = `${config.gridRows * cellSize}px`;
            
            // Update fontSize for icons
            const cells = document.querySelectorAll('.grid-cell');
            const fontSize = Math.floor(cellSize * 0.7) + 'px';
            cells.forEach(c => {
                c.style.fontSize = fontSize;
            });
        }

        window.addEventListener('resize', () => { resizeBoard(); });

        // --- GAMEPAD LOGIC ---
        let gamepadIndex = null;
        let gpButtonState = { pause: false };

        window.addEventListener("gamepadconnected", (e) => {
            gamepadIndex = e.gamepad.index;
            showToast("üéÆ Controller Disambung!");
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            if (gamepadIndex === e.gamepad.index) {
                gamepadIndex = null;
                showToast("‚ùå Controller Terputus");
            }
        });

        function pollGamepad() {
            if (gamepadIndex !== null) {
                const gamepad = navigator.getGamepads()[gamepadIndex];
                if (gamepad) {
                    const threshold = 0.5;
                    const isPressed = (btnIdx, axisIdx, val) => {
                        return (gamepad.buttons[btnIdx] && gamepad.buttons[btnIdx].pressed) || 
                               (gamepad.axes[axisIdx] && (val < 0 ? gamepad.axes[axisIdx] < val : gamepad.axes[axisIdx] > val));
                    };

                    const up = isPressed(12, 1, -threshold);
                    const down = isPressed(13, 1, threshold);
                    const left = isPressed(14, 0, -threshold);
                    const right = isPressed(15, 0, threshold);
                    const pause = gamepad.buttons[9] && gamepad.buttons[9].pressed; 

                    if (up && direction.y === 0) nextDirection = {x: 0, y: -1};
                    if (down && direction.y === 0) nextDirection = {x: 0, y: 1};
                    if (left && direction.x === 0) nextDirection = {x: -1, y: 0};
                    if (right && direction.x === 0) nextDirection = {x: 1, y: 0};

                    if (pause && !gpButtonState.pause) { togglePause(); }
                    gpButtonState.pause = pause;
                }
            }
            requestAnimationFrame(pollGamepad);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- INIT ---
        function initGrid() {
            detectOrientationAndSetGrid();
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            for (let i = 0; i < config.gridCols * config.gridRows; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                container.appendChild(cell);
            }
            // Use RequestAnimationFrame for layout stability
            requestAnimationFrame(() => {
                resizeBoard();
                populateStartLegend();
                pollGamepad(); // Start gamepad polling
            });
        }

        function populateSidebar() {
            const sidebar = document.getElementById('sidebarLegend');
            sidebar.innerHTML = '';
            
            const allItems = [...correctAnswersData, ...wrongAnswersData];
            allItems.sort((a, b) => a.label.localeCompare(b.label));
            const remainingItems = allItems.filter(item => !eatenIds.has(item.id));

            if (remainingItems.length > 0) {
                remainingItems.forEach(item => {
                    sidebar.innerHTML += `
                        <div class="mini-legend-item">
                            <span class="mini-legend-icon">${item.icon}</span>
                            <span>${item.label}</span>
                        </div>
                    `;
                });
            } else {
                sidebar.innerHTML += `<div class="legend-section-title" style="color:green; text-align:center;">Selesai!</div>`;
            }
        }

        function populateStartLegend() {
            const container = document.getElementById('startLegend');
            container.innerHTML = '';
            const allItems = [...correctAnswersData, ...wrongAnswersData];
            allItems.sort((a, b) => a.label.localeCompare(b.label));
            allItems.forEach(item => {
                container.innerHTML += `
                    <div style="display: flex; align-items: center; gap: 5px; background: white; padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.75rem; box-shadow: 0 1px 1px rgba(0,0,0,0.05);">
                        <span style="font-size: 1rem;">${item.icon}</span>
                        <span style="font-weight: 600; color: #444; line-height:1.1;">${item.label}</span>
                    </div>
                `;
            });
        }

        // --- INPUTS ---
        let touchStartX = 0;
        let touchStartY = 0;

        document.getElementById('gameBoard').addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false});

        document.getElementById('gameBoard').addEventListener('touchmove', (e) => e.preventDefault(), {passive: false});

        document.getElementById('gameBoard').addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
        }, {passive: false});

        function handleSwipe(startX, startY, endX, endY) {
            if (!isGameRunning || isPaused) return;
            const diffX = endX - startX;
            const diffY = endY - startY;
            if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return;
            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0 && direction.x === 0) nextDirection = {x: 1, y: 0};
                else if (diffX < 0 && direction.x === 0) nextDirection = {x: -1, y: 0};
            } else {
                if (diffY > 0 && direction.y === 0) nextDirection = {x: 0, y: 1};
                else if (diffY < 0 && direction.y === 0) nextDirection = {x: 0, y: -1};
            }
        }

        function handleDPad(dir, e) {
            e.preventDefault(); 
            if (!isGameRunning || isPaused) return;
            switch(dir) {
                case 'up': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'down': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'left': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'right': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        }

        // --- GAME CONTROL ---
        function changeSpeed(val) {
            config.speed = parseInt(val);
            if (isGameRunning && !isPaused) {
                clearInterval(gameInterval);
                gameInterval = setInterval(gameLoop, config.speed);
                document.activeElement.blur(); 
            }
        }

        function togglePause() {
            if (!isGameRunning) return;
            isPaused = !isPaused;
            if (isPaused) {
                document.getElementById('pauseOverlay').classList.add('active');
                document.getElementById('pauseBtnIcon').textContent = '‚ñ∂';
            } else {
                document.getElementById('pauseOverlay').classList.remove('active');
                document.getElementById('pauseBtnIcon').textContent = '‚è∏Ô∏è';
            }
        }

        function showMainMenu() {
            isGameRunning = false;
            isPaused = false;
            clearInterval(gameInterval);
            document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
            document.getElementById('startOverlay').classList.add('active');
        }

        function startGameSession() {
            document.getElementById('startOverlay').classList.remove('active');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resetGame();
        }

        function resetGame() {
            document.querySelectorAll('.overlay').forEach(el => {
                if(el.id !== 'startOverlay') el.classList.remove('active');
            });

            detectOrientationAndSetGrid();
            initGrid();

            snake = [{x: 5, y: 5}, {x: 4, y: 5}, {x: 3, y: 5}];
            direction = {x: 1, y: 0};
            nextDirection = {x: 1, y: 0};
            collectedIds.clear();
            eatenIds.clear(); 
            penaltyScore = 0;
            isGameRunning = true;
            isPaused = false;
            document.getElementById('pauseBtnIcon').textContent = '‚è∏Ô∏è';

            const speedSelect = document.getElementById('speedSelect');
            config.speed = parseInt(speedSelect.value);

            generateItems();
            updateScoreDisplay();
            resizeBoard();
            renderBoard();
            populateSidebar();
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, config.speed);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
            setTimeout(resizeBoard, 200);
        }

        // --- GAME LOGIC ---
        function generateItems() {
            activeCorrectAnswers = [];
            activeWrongAnswers = [];
            const usedPositions = new Set();
            snake.forEach(s => usedPositions.add(`${s.x},${s.y}`));

            const getRandomPos = () => {
                let x, y, key;
                do {
                    x = Math.floor(Math.random() * config.gridCols);
                    y = Math.floor(Math.random() * config.gridRows);
                    key = `${x},${y}`;
                } while (usedPositions.has(key));
                usedPositions.add(key);
                return {x, y};
            };

            correctAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeCorrectAnswers.push({ ...pos, data: item });
            });
            wrongAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeWrongAnswers.push({ ...pos, icon: item.icon, id: item.id });
            });
        }

        function renderBoard() {
            const cells = document.querySelectorAll('.grid-cell');
            // Quick clear
            for (let i = 0; i < cells.length; i++) {
                cells[i].className = 'grid-cell';
                cells[i].textContent = '';
                cells[i].style.fontSize = Math.floor(cellSize * 0.7) + 'px';
            }

            activeCorrectAnswers.forEach(item => {
                if (collectedIds.has(item.data.id)) return;
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) cells[idx].textContent = item.data.icon;
            });

            activeWrongAnswers.forEach(item => {
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) {
                    cells[idx].textContent = item.icon;
                    cells[idx].style.opacity = '0.7';
                }
            });

            snake.forEach((seg, i) => {
                const idx = seg.y * config.gridCols + seg.x;
                if (cells[idx]) {
                    if (i === 0) {
                        cells[idx].classList.add('snake-head');
                        cells[idx].innerHTML = `
                            <div class="snake-face">
                                <div class="eyes-row">
                                    <div class="eye"><div class="pupil"></div></div>
                                    <div class="eye"><div class="pupil"></div></div>
                                </div>
                                <div class="cheek cheek-left"></div>
                                <div class="cheek cheek-right"></div>
                                <div class="mouth"></div>
                            </div>`;
                    } else {
                        cells[idx].classList.add('snake-segment');
                    }
                }
            });
        }

        function gameLoop() {
            if (!isGameRunning || isPaused) return;

            direction = nextDirection;
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // Wrap logic
            if (head.x < 0) head.x = config.gridCols - 1;
            if (head.x >= config.gridCols) head.x = 0;
            if (head.y < 0) head.y = config.gridRows - 1;
            if (head.y >= config.gridRows) head.y = 0;

            if (snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver(false);
                return;
            }

            snake.unshift(head);
            let ateFood = false;

            const correctIdx = activeCorrectAnswers.findIndex(
                item => !collectedIds.has(item.data.id) && item.x === head.x && item.y === head.y
            );

            if (correctIdx !== -1) {
                const item = activeCorrectAnswers[correctIdx];
                collectedIds.add(item.data.id);
                eatenIds.add(item.data.id);
                playSound('eat');
                const board = document.getElementById('gameBoard');
                board.classList.add('flash-correct');
                setTimeout(() => board.classList.remove('flash-correct'), 300);
                ateFood = true;
                populateSidebar();

                if (collectedIds.size === correctAnswersData.length) {
                    updateScoreDisplay();
                    gameOver(true);
                    return;
                }
            }

            const wrongIdx = activeWrongAnswers.findIndex(
                item => item.x === head.x && item.y === head.y
            );

            if (wrongIdx !== -1) {
                const item = activeWrongAnswers[wrongIdx];
                eatenIds.add(item.id);
                penaltyScore += 5;
                playSound('wrong');
                const board = document.getElementById('gameBoard');
                board.classList.add('flash-wrong');
                setTimeout(() => board.classList.remove('flash-wrong'), 300);
                activeWrongAnswers.splice(wrongIdx, 1);
                populateSidebar();
                if (snake.length > 2) snake.pop();
            }

            if (!ateFood) snake.pop();
            updateScoreDisplay();
            renderBoard();
        }

        function updateScoreDisplay() {
            const baseScore = (collectedIds.size / correctAnswersData.length) * 100;
            const finalScore = Math.max(0, Math.round(baseScore - penaltyScore));
            document.getElementById('scorePanel').innerText = `Markah: ${finalScore}%`;
        }

        function gameOver(win) {
            isGameRunning = false;
            clearInterval(gameInterval);
            playSound(win ? 'win' : 'wrong');
            const baseScore = (collectedIds.size / correctAnswersData.length) * 100;
            const finalScore = Math.max(0, Math.round(baseScore - penaltyScore));

            if (win) {
                document.getElementById('finalScoreWin').innerText = `Markah: ${finalScore}%`;
                document.getElementById('celebrationOverlay').classList.add('active');
            } else {
                document.getElementById('finalScoreLose').innerText = `Markah: ${finalScore}%`;
                document.getElementById('wrongAnswerOverlay').classList.add('active');
            }
        }

        document.addEventListener('keydown', e => {
            if (e.code === 'Space') { e.preventDefault(); togglePause(); return; }
            if (!isGameRunning || isPaused) return;
            switch(e.key) {
                case 'ArrowUp': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'ArrowDown': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'ArrowLeft': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'ArrowRight': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        });

        initGrid();
        populateSidebar();
    </script>
 </body>
</html>
