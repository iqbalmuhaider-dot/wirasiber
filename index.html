<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Captain Pillar - Peranti Digital</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', cursive, sans-serif;
            overflow: hidden; /* No scroll on body */
            background-color: #87CEEB;
            height: 100vh;
            width: 100vw;
            touch-action: none; /* Prevent browser zooming/scrolling on touch */
        }

        #app {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            box-sizing: border-box;
            position: relative;
        }

        /* --- SCHOOL HEADER --- */
        .school-header {
            text-align: center;
            margin-bottom: 0.5rem;
            color: #1565C0;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            animation: fadeIn 1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .school-name {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .school-logo-img {
            height: 60px; /* Saiz logo */
            width: auto;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }
        
        .school-logo-img:hover {
            transform: scale(1.1);
        }

        /* --- HEADER SECTION --- */
        .header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
            z-index: 10;
        }

        .question-bar {
            padding: 0.5rem 1rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            background: #FFD700;
            width: 100%;
            max-width: 800px;
        }

        .question-text {
            font-size: clamp(1rem, 3.5vw, 1.6rem);
            font-weight: bold;
            margin: 0;
            color: #333;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4);
            line-height: 1.2;
        }

        .controls-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-small {
            background: white;
            border: 2px solid #ddd;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            outline: none;
            user-select: none;
        }

        .btn-small:hover { transform: translateY(-2px); }
        .btn-small:active { transform: translateY(0); }

        .btn-restart { color: #d32f2f; border-color: #ffcdd2; background: #ffebee; }
        .btn-pause { color: #f57c00; border-color: #ffe0b2; background: #fff3e0; }
        .btn-fullscreen { color: #1976d2; border-color: #bbdefb; background: #e3f2fd; }
        
        select.btn-small {
            appearance: none;
            -webkit-appearance: none;
            padding-right: 1.8rem;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem top 50%;
            background-size: 0.6rem auto;
            color: #333;
        }

        /* --- MAIN GAME LAYOUT --- */
        .game-container {
            flex: 1;
            display: flex;
            overflow: hidden; 
            gap: 1rem;
            justify-content: center;
            align-items: flex-start;
            height: 100%;
        }

        /* LEFT SIDEBAR (Legend) */
        .sidebar {
            width: 220px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 95%; 
            border: 2px solid #fff;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            background: #f0f4f8;
            padding: 0.6rem;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 0.9rem;
            color: #444;
        }

        .sidebar-content {
            overflow-y: auto;
            padding: 0.5rem;
            flex: 1;
        }

        .mini-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            animation: slideIn 0.3s ease;
        }
        
        .mini-legend-item:last-child { border-bottom: none; }
        .mini-legend-icon { font-size: 1.2rem; min-width: 25px; text-align: center; }

        .legend-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #666;
            margin: 0.5rem 0 0.2rem 0;
            padding-bottom: 0.2rem;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
        }

        /* CENTER GAME AREA */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .game-board {
            background: #FFFFFF;
            border: 4px solid #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            position: relative;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-board.flash-correct { animation: flashBlue 0.5s ease; }
        .game-board.flash-wrong { animation: flashRed 0.5s ease; }

        @keyframes flashBlue { 0%, 100% { border-color: #fff; } 50% { border-color: #2196F3; } }
        @keyframes flashRed { 0%, 100% { border-color: #fff; } 50% { border-color: #F44336; } }

        .grid-container { display: grid; }

        .grid-cell {
            background-color: #F8F9FA;
            border: 1px solid #EEEEEE;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-sizing: border-box;
        }

        /* Snake Styles */
        .snake-segment {
            background: #4CAF50 !important;
            border-radius: 50%;
            border: 1px solid #2E7D32 !important;
            z-index: 2;
            transform: scale(0.92);
        }

        .snake-head {
            background: #388E3C !important;
            z-index: 3;
            border-radius: 50%;
            transform: scale(1.15);
            position: relative;
            display: flex !important;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        /* CUTE FACE CSS */
        .snake-face {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .eyes-row {
            display: flex;
            gap: 15%; 
            margin-bottom: 5%;
            width: 65%;
            justify-content: center;
        }
        
        .eye {
            width: 32%;
            padding-bottom: 32%;
            background: white;
            border-radius: 50%;
            position: relative;
        }
        
        .pupil {
            position: absolute;
            top: 25%;
            right: 25%;
            width: 50%;
            height: 50%;
            background: #333;
            border-radius: 50%;
        }
        
        .mouth {
            width: 45%;
            height: 20%;
            border-bottom: 0.15em solid white;
            border-radius: 0 0 50% 50%;
            margin-top: -5%;
        }

        .cheek {
            position: absolute;
            top: 55%;
            width: 22%;
            height: 15%;
            background: #FF8A80;
            border-radius: 50%;
            opacity: 0.6;
        }
        .cheek-left { left: 5%; }
        .cheek-right { right: 5%; }

        .score-float {
            position: absolute;
            top: 0px;
            right: 0px;
            background: rgba(255,255,255,0.95);
            padding: 0.5rem 1rem;
            border-radius: 0 0 0 15px;
            font-weight: 800;
            box-shadow: -2px 2px 8px rgba(0,0,0,0.15);
            font-size: 1.1rem;
            color: #2E7D32;
            z-index: 5;
            pointer-events: none;
            border: 2px solid #4CAF50;
            border-top: none;
            border-right: none;
        }

        /* --- MOBILE D-PAD --- */
        .mobile-controls {
            display: none;
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 50px 50px;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .d-pad-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #ccc;
            border-radius: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 0 #bbb;
            user-select: none;
            cursor: pointer;
        }

        .d-pad-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #bbb;
            background: #e3f2fd;
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }

        .modal-box {
            background: white;
            padding: 1.5rem;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 85%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: popIn 0.4s;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-title { font-size: 2rem; margin-bottom: 0.5rem; color: #333; font-weight: 800; }
        .modal-text { font-size: 1.1rem; color: #555; margin-bottom: 1.5rem; }
        
        .btn-primary {
            background: linear-gradient(to bottom, #4CAF50, #45a049);
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #2E7D32;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 2px 0 #2E7D32; }

        /* --- PAUSE OVERLAY --- */
        #pauseOverlay .modal-box {
            background: #FFF3E0;
            border: 4px solid #FFB74D;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 800px) {
            .game-container { 
                flex-direction: column; 
                gap: 0.5rem; 
                justify-content: space-between;
            }
            
            .sidebar { 
                width: 100%; 
                height: auto; 
                max-height: 120px;
                order: 3;
                border: none;
                background: rgba(255,255,255,0.6);
            }
            .sidebar-header { padding: 0.4rem; font-size: 0.8rem; }
            .sidebar-content {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
                padding: 0.3rem;
            }
            .mini-legend-item { 
                border: 1px solid #ddd; 
                background: white; 
                border-radius: 8px; 
                padding: 0.2rem 0.5rem; 
                font-size: 0.75rem;
            }
            .legend-section-title { display: none; } /* Hide headers on mobile to save space */
            
            .game-area {
                order: 2;
                justify-content: flex-start;
                flex: 1;
            }

            .mobile-controls {
                display: grid;
            }

            .modal-title { font-size: 1.6rem; }
            .modal-text { font-size: 0.95rem; }
            .btn-primary { font-size: 1.1rem; padding: 0.6rem 1.8rem; }
            
            .school-header { margin-bottom: 0.2rem; }
            .school-logo-img { height: 40px; }
            .school-name { font-size: 1rem; gap: 0.5rem; }
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
 </head>
 <body>

  <div id="app">
    
   <!-- 1. School Header -->
   <div class="school-header">
       <div class="school-name">
           <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" alt="Logo SKMT" class="school-logo-img">
           Laman Interaktif SK MASJID TANAH (INTEGRASI)
       </div>
   </div>

   <!-- 2. Header & Controls -->
   <div class="header-section" id="headerSection">
       <div class="question-bar">
           <h1 class="question-text" id="questionText">Jenis-Jenis Peranti Digital?</h1>
       </div>
       <div class="controls-bar">
           
           <!-- Speed Selector -->
           <select id="speedSelect" class="btn-small" onchange="changeSpeed(this.value)" title="Laraskan Kelajuan">
               <option value="350">üêå Santai</option>
               <option value="200" selected>üêõ Biasa</option>
               <option value="100">üöÄ Laju</option>
           </select>

           <!-- Controls -->
           <button class="btn-small btn-pause" onclick="togglePause()">
               <span id="pauseBtnIcon">‚è∏Ô∏è</span> Jeda
           </button>
           <button class="btn-small btn-restart" onclick="showMainMenu()">
               <span>‚Üª</span> Mula Semula
           </button>
           <button class="btn-small btn-fullscreen" onclick="toggleFullScreen()">
               <span>‚õ∂</span> Skrin Penuh
           </button>
       </div>
   </div>

   <!-- 3. Main Layout -->
   <div class="game-container">
       
       <!-- Left Sidebar: Legend -->
       <div class="sidebar">
           <div class="sidebar-header">üìù Senarai Simbol</div>
           <div class="sidebar-content" id="sidebarLegend">
               <!-- Populated by JS -->
           </div>
       </div>

       <!-- Center: Game Board & Mobile Controls -->
       <div class="game-area" id="gameArea">
           <div class="score-float" id="scorePanel">Markah: 0%</div>
           
           <div class="game-board" id="gameBoard">
               <div class="grid-container" id="gridContainer"></div>
           </div>

           <!-- Mobile D-Pad -->
           <div class="mobile-controls">
               <div style="grid-column: 2; grid-row: 1;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('up', event)">‚¨ÜÔ∏è</button>
               </div>
               <div style="grid-column: 1; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('left', event)">‚¨ÖÔ∏è</button>
               </div>
               <div style="grid-column: 2; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('down', event)">‚¨áÔ∏è</button>
               </div>
               <div style="grid-column: 3; grid-row: 2;">
                   <button class="d-pad-btn" onpointerdown="handleDPad('right', event)">‚û°Ô∏è</button>
               </div>
           </div>
       </div>

   </div>

   <!-- START OVERLAY -->
   <div class="overlay active" id="startOverlay">
       <div class="modal-box">
           <h2 class="modal-title">üêõ Captain Pillar</h2>
           <p class="modal-text">
               Gunakan kekunci panah ‚å®Ô∏è<br>atau gerakkan jari (swipe) üëÜ untuk bermain.<br><br>
               <strong>Misi:</strong> Cari semua peranti digital yang hilang!
           </p>
           <button class="btn-primary" onclick="startGameSession()">MULA ‚ñ∂</button>
       </div>
   </div>

   <!-- PAUSE OVERLAY -->
   <div class="overlay" id="pauseOverlay">
       <div class="modal-box">
           <h2 class="modal-title">‚è∏Ô∏è Permainan Dijeda</h2>
           <p class="modal-text">Tekan butang di bawah atau "Spacebar" untuk sambung semula.</p>
           <button class="btn-primary" style="background: #FF9800; box-shadow: 0 6px 0 #E65100;" onclick="togglePause()">SAMBUNG ‚ñ∂</button>
       </div>
   </div>

   <!-- WIN OVERLAY -->
   <div class="overlay" id="celebrationOverlay">
    <div class="modal-box">
     <div style="font-size: 4rem; margin-bottom: 0.5rem;">üéâüèÜüéâ</div>
     <h2 class="modal-title">Tahniah!</h2>
     <p class="modal-text" id="finalScoreWin">Markah Penuh: 100%</p>
     <button class="btn-primary" onclick="showMainMenu()">MAIN LAGI ‚Üª</button>
    </div>
   </div>

   <!-- LOSE OVERLAY -->
   <div class="overlay" id="wrongAnswerOverlay">
    <div class="modal-box">
     <div style="font-size: 4rem; margin-bottom: 0.5rem;">üò¢üí•</div>
     <h2 class="modal-title">Tamat</h2>
     <p class="modal-text" id="finalScoreLose">Terlanggar!</p>
     <button class="btn-primary" onclick="showMainMenu()">CUBA LAGI ‚Üª</button>
    </div>
   </div>

  </div>

  <script>
        // --- CONFIG & DATA ---
        let config = {
            gridCols: 25, // Default Landscape
            gridRows: 18, 
            speed: 200
        };

        const correctAnswersData = [
            { id: 'smartphone', icon: 'üì±', label: 'Telefon Pintar' },
            { id: 'tablet', icon: 'üì≤', label: 'Tablet' },
            { id: 'desktop', icon: 'üñ•Ô∏è', label: 'Komputer Meja' },
            { id: 'laptop', icon: 'üíª', label: 'Komputer Riba (Laptop)' },
            { id: 'smarttv', icon: 'üì∫', label: 'Televisyen Pintar' },
            { id: 'smartwatch', icon: '‚åö', label: 'Jam Pintar' },
            { id: 'camera', icon: 'üì∑', label: 'Kamera Digital' },
            { id: 'console', icon: 'üéÆ', label: 'Konsol Permainan' }
        ];

        const wrongAnswersData = [
            { id: 'typewriter', icon: '‚å®Ô∏è', label: 'Mesin Taip' },
            { id: 'publicphone', icon: '‚òéÔ∏è', label: 'Telefon Awam' },
            { id: 'abacus', icon: 'üßÆ', label: 'Sempoa' },
            { id: 'oldradio', icon: 'üìª', label: 'Radio Lama' },
            { id: 'letter', icon: '‚úâÔ∏è', label: 'Surat' },
            { id: 'newspaper', icon: 'üì∞', label: 'Surat Khabar' },
            { id: 'map', icon: 'üó∫Ô∏è', label: 'Peta Kertas' },
            { id: 'clock', icon: 'üï∞Ô∏è', label: 'Jam Dinding' },
            { id: 'candle', icon: 'üïØÔ∏è', label: 'Lilin' },
            { id: 'fan', icon: 'ü™≠', label: 'Kipas Tangan' }
        ];

        // --- STATE ---
        let snake = [];
        let direction = {x: 1, y: 0};
        let nextDirection = {x: 1, y: 0};
        let gameInterval;
        let isGameRunning = false;
        let isPaused = false;
        let activeCorrectAnswers = [];
        let activeWrongAnswers = [];
        let collectedIds = new Set();
        let eatenIds = new Set(); // Track all eaten items (correct or wrong) to remove from list
        let cellSize = 20;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const now = audioCtx.currentTime;
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'eat') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'win') {
                [440, 554, 659].forEach((f, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.4); o.start(now); o.stop(now+0.4); });
            }
        }

        // --- ADAPTIVE GRID & RESIZING LOGIC ---
        
        function detectOrientationAndSetGrid() {
            const isPortrait = window.innerHeight > window.innerWidth;
            if (isPortrait) {
                config.gridCols = 15;
                config.gridRows = 22;
            } else {
                config.gridCols = 25;
                config.gridRows = 18;
            }
        }

        function resizeBoard() {
            const gameArea = document.getElementById('gameArea');
            const dPad = document.querySelector('.mobile-controls');
            
            let availHeight = gameArea.clientHeight;
            if (getComputedStyle(dPad).display !== 'none') {
                availHeight -= (dPad.offsetHeight + 20);
            }

            const availWidth = gameArea.clientWidth;
            const maxW = (availWidth - 4) / config.gridCols;
            const maxH = (availHeight - 4) / config.gridRows;
            
            cellSize = Math.floor(Math.min(maxW, maxH));
            
            const gridContainer = document.getElementById('gridContainer');
            gridContainer.style.gridTemplateColumns = `repeat(${config.gridCols}, ${cellSize}px)`;
            gridContainer.style.gridTemplateRows = `repeat(${config.gridRows}, ${cellSize}px)`;
            gridContainer.style.width = `${config.gridCols * cellSize}px`;
            gridContainer.style.height = `${config.gridRows * cellSize}px`;
            
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(c => {
                c.style.width = `${cellSize}px`;
                c.style.height = `${cellSize}px`;
                c.style.fontSize = `${cellSize * 0.7}px`;
            });
        }

        window.addEventListener('resize', () => { resizeBoard(); });

        // --- INIT ---
        function initGrid() {
            detectOrientationAndSetGrid();
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            for (let i = 0; i < config.gridCols * config.gridRows; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                container.appendChild(cell);
            }
            setTimeout(resizeBoard, 50);
        }

        function populateSidebar() {
            const sidebar = document.getElementById('sidebarLegend');
            sidebar.innerHTML = '';
            
            // Combine all items, remove those that are eaten (collectedIds + any wrong items eaten if tracked, 
            // but for simplicity, we just track collectedIds for correct ones and we can track wrong ones too)
            
            // To be truly neutral, we combine and sort them
            const allItems = [...correctAnswersData, ...wrongAnswersData];
            allItems.sort((a, b) => a.label.localeCompare(b.label));

            // Filter out items that have been interacted with (eaten)
            const remainingItems = allItems.filter(item => !eatenIds.has(item.id));

            if (remainingItems.length > 0) {
                remainingItems.forEach(item => {
                    sidebar.innerHTML += `
                        <div class="mini-legend-item">
                            <span class="mini-legend-icon">${item.icon}</span>
                            <span>${item.label}</span>
                        </div>
                    `;
                });
            } else {
                sidebar.innerHTML += `<div class="legend-section-title" style="color:green; text-align:center;">Selesai!</div>`;
            }
        }

        // --- TOUCH / SWIPE LOGIC ---
        let touchStartX = 0;
        let touchStartY = 0;

        document.getElementById('gameBoard').addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false});

        document.getElementById('gameBoard').addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, {passive: false});

        document.getElementById('gameBoard').addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
        }, {passive: false});

        function handleSwipe(startX, startY, endX, endY) {
            if (!isGameRunning || isPaused) return;
            const diffX = endX - startX;
            const diffY = endY - startY;

            if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return;

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0 && direction.x === 0) nextDirection = {x: 1, y: 0};
                else if (diffX < 0 && direction.x === 0) nextDirection = {x: -1, y: 0};
            } else {
                if (diffY > 0 && direction.y === 0) nextDirection = {x: 0, y: 1};
                else if (diffY < 0 && direction.y === 0) nextDirection = {x: 0, y: -1};
            }
        }

        // --- D-PAD LOGIC ---
        function handleDPad(dir, e) {
            e.preventDefault(); 
            if (!isGameRunning || isPaused) return;

            switch(dir) {
                case 'up': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'down': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'left': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'right': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        }

        // --- GAME CONTROL ---
        function changeSpeed(val) {
            config.speed = parseInt(val);
            if (isGameRunning && !isPaused) {
                clearInterval(gameInterval);
                gameInterval = setInterval(gameLoop, config.speed);
                document.activeElement.blur(); 
            }
        }

        function togglePause() {
            if (!isGameRunning) return;
            isPaused = !isPaused;
            
            if (isPaused) {
                document.getElementById('pauseOverlay').classList.add('active');
                document.getElementById('pauseBtnIcon').textContent = '‚ñ∂';
            } else {
                document.getElementById('pauseOverlay').classList.remove('active');
                document.getElementById('pauseBtnIcon').textContent = '‚è∏Ô∏è';
            }
        }

        function showMainMenu() {
            isGameRunning = false;
            isPaused = false;
            clearInterval(gameInterval);
            document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
            document.getElementById('startOverlay').classList.add('active');
        }

        function startGameSession() {
            document.getElementById('startOverlay').classList.remove('active');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resetGame();
        }

        function resetGame() {
            document.querySelectorAll('.overlay').forEach(el => {
                if(el.id !== 'startOverlay') el.classList.remove('active');
            });

            detectOrientationAndSetGrid();
            initGrid();

            snake = [{x: 5, y: 5}, {x: 4, y: 5}, {x: 3, y: 5}];
            direction = {x: 1, y: 0};
            nextDirection = {x: 1, y: 0};
            collectedIds.clear();
            eatenIds.clear(); // Reset eaten tracking
            isGameRunning = true;
            isPaused = false;
            document.getElementById('pauseBtnIcon').textContent = '‚è∏Ô∏è';

            const speedSelect = document.getElementById('speedSelect');
            config.speed = parseInt(speedSelect.value);

            generateItems();
            updateScoreDisplay();
            resizeBoard();
            renderBoard();
            populateSidebar(); // Reset sidebar
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, config.speed);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(err);
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
            setTimeout(resizeBoard, 200);
        }

        // --- GAME LOGIC ---
        function generateItems() {
            activeCorrectAnswers = [];
            activeWrongAnswers = [];
            const usedPositions = new Set();
            snake.forEach(s => usedPositions.add(`${s.x},${s.y}`));

            const getRandomPos = () => {
                let x, y, key;
                do {
                    x = Math.floor(Math.random() * config.gridCols);
                    y = Math.floor(Math.random() * config.gridRows);
                    key = `${x},${y}`;
                } while (usedPositions.has(key));
                usedPositions.add(key);
                return {x, y};
            };

            correctAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeCorrectAnswers.push({ ...pos, data: item });
            });
            wrongAnswersData.forEach(item => {
                const pos = getRandomPos();
                activeWrongAnswers.push({ ...pos, icon: item.icon, id: item.id });
            });
        }

        function renderBoard() {
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach(cell => {
                cell.textContent = '';
                cell.className = 'grid-cell';
                cell.style.opacity = '1';
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                cell.style.fontSize = `${cellSize * 0.7}px`;
                cell.innerHTML = '';
            });

            activeCorrectAnswers.forEach(item => {
                if (collectedIds.has(item.data.id)) return;
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) cells[idx].textContent = item.data.icon;
            });

            activeWrongAnswers.forEach(item => {
                const idx = item.y * config.gridCols + item.x;
                if (cells[idx]) {
                    cells[idx].textContent = item.icon;
                    cells[idx].style.opacity = '0.6';
                }
            });

            snake.forEach((seg, i) => {
                const idx = seg.y * config.gridCols + seg.x;
                if (cells[idx]) {
                    if (i === 0) {
                        cells[idx].classList.add('snake-head');
                        cells[idx].innerHTML = `
                            <div class="snake-face">
                                <div class="eyes-row">
                                    <div class="eye"><div class="pupil"></div></div>
                                    <div class="eye"><div class="pupil"></div></div>
                                </div>
                                <div class="cheek cheek-left"></div>
                                <div class="cheek cheek-right"></div>
                                <div class="mouth"></div>
                            </div>
                        `;
                    } else {
                        cells[idx].classList.add('snake-segment');
                        cells[idx].textContent = ''; 
                    }
                }
            });
        }

        function gameLoop() {
            if (!isGameRunning || isPaused) return;

            direction = nextDirection;
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (head.x < 0) head.x = config.gridCols - 1;
            if (head.x >= config.gridCols) head.x = 0;
            if (head.y < 0) head.y = config.gridRows - 1;
            if (head.y >= config.gridRows) head.y = 0;

            if (snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver(false);
                return;
            }

            snake.unshift(head);
            let ateFood = false;

            const correctIdx = activeCorrectAnswers.findIndex(
                item => !collectedIds.has(item.data.id) && item.x === head.x && item.y === head.y
            );

            if (correctIdx !== -1) {
                const item = activeCorrectAnswers[correctIdx];
                collectedIds.add(item.data.id);
                eatenIds.add(item.data.id); // Add to eaten set
                
                playSound('eat');
                document.getElementById('gameBoard').classList.add('flash-correct');
                setTimeout(() => document.getElementById('gameBoard').classList.remove('flash-correct'), 300);
                ateFood = true;
                populateSidebar(); // Update checklist

                if (collectedIds.size === correctAnswersData.length) {
                    updateScoreDisplay(); // Update to 100%
                    gameOver(true);
                    return;
                }
            }

            const wrongIdx = activeWrongAnswers.findIndex(
                item => item.x === head.x && item.y === head.y
            );

            if (wrongIdx !== -1) {
                const item = activeWrongAnswers[wrongIdx];
                eatenIds.add(item.id); // Add to eaten set so it disappears from sidebar too
                
                playSound('wrong');
                document.getElementById('gameBoard').classList.add('flash-wrong');
                setTimeout(() => document.getElementById('gameBoard').classList.remove('flash-wrong'), 300);
                
                activeWrongAnswers.splice(wrongIdx, 1);
                populateSidebar(); // Update checklist to remove wrong item
                
                if (snake.length > 2) snake.pop();
            }

            if (!ateFood) snake.pop();
            updateScoreDisplay();
            renderBoard();
        }

        function updateScoreDisplay() {
            const percentage = Math.round((collectedIds.size / correctAnswersData.length) * 100);
            document.getElementById('scorePanel').innerText = `Markah: ${percentage}%`;
        }

        function gameOver(win) {
            isGameRunning = false;
            clearInterval(gameInterval);
            playSound(win ? 'win' : 'wrong');
            
            if (win) {
                document.getElementById('finalScoreWin').innerText = `Markah Penuh: 100%`;
                document.getElementById('celebrationOverlay').classList.add('active');
            } else {
                const percentage = Math.round((collectedIds.size / correctAnswersData.length) * 100);
                document.getElementById('finalScoreLose').innerText = `Markah Akhir: ${percentage}%`;
                document.getElementById('wrongAnswerOverlay').classList.add('active');
            }
        }

        document.addEventListener('keydown', e => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePause();
                return;
            }

            if (!isGameRunning || isPaused) return;
            switch(e.key) {
                case 'ArrowUp': if (direction.y === 0) nextDirection = {x: 0, y: -1}; break;
                case 'ArrowDown': if (direction.y === 0) nextDirection = {x: 0, y: 1}; break;
                case 'ArrowLeft': if (direction.x === 0) nextDirection = {x: -1, y: 0}; break;
                case 'ArrowRight': if (direction.x === 0) nextDirection = {x: 1, y: 0}; break;
            }
        });

        initGrid();
        populateSidebar();
    </script>
 </body>
</html>
